name: Tag and Release

on:
  pull_request:
    types:
      - closed

jobs:
  tag_and_release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Get PR information and check if it's targeting the main branch
      id: pr
      run: |
        PR_NUMBER=$(echo $GITHUB_REF | awk -F'/' '{print $3}')
        echo "GH_TOKEN=${{ secrets.GIT_TOKEN }}" >> $GITHUB_ENV
        PR_BASE_BRANCH=$(gh pr view $PR_NUMBER --json base_ref -q .base_ref)
        if [ "$PR_BASE_BRANCH" != "main" ]; then
          echo "This PR is not targeting the main branch. Exiting."
          exit 0
        fi
        PR_NAME=$(gh pr view $PR_NUMBER --json title -q .title)
        echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
        echo "PR_NAME=$PR_NAME" >> $GITHUB_ENV
    
    - name: Set Git user identity
      run: |
        git config --local user.email "jatinjangir0220@gmail.com"
        git config --local user.name "jatin-jangir"


    - name: Generate kustomize outputs for overlays
      run: |
        for overlay in overlays/*; do
          overlay_name=$(basename '$overlay')
          output_folder='testPR/$overlay_name'
          mkdir -p '$output_folder'
          kustomize build '$overlay' > '$output_folder/kustomize_output.yaml'
          git add '$output_folder/kustomize_output.yaml'
        done
    - name: Commit changes to tag
      run: |
        git commit -m "Update kustomize outputs for overlays" || true  # Ignore if there are no changes
        GH_TOKEN="${{ secrets.GIT_TOKEN }}" gh auth login --with-token <<< "$GH_TOKEN"
        tag='pr-${PR_NAME// /_}'  # Replace spaces with underscores
        git tag '$tag' -m 'Tag for PR #${PR_NUMBER}'
        git push origin "$tag"
